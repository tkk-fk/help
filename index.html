<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ヘルプ印籠 - 伝えたい言葉を大きく表示</title>
  <meta name="theme-color" content="#ff3b30" />
  <style>
    :root{
      --fg:#111; --bg:#fff; --muted:#666;
      --acc:#0a84ff; --card:#f7f8fa; --border:#e2e6ec;
      --danger:#ff3b30; --warn:#ff9f0a; --calm:#0a84ff; --neutral:#6c6d70;
      --radius:20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg); background:#fff;
      font-family: system-ui,-apple-system,"Segoe UI","Noto Sans JP","Hiragino Sans",Meiryo,sans-serif;
      line-height:1.6;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.9); backdrop-filter:saturate(1.1) blur(6px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:960px; margin:0 auto; padding:12px 16px}
    h1{margin:0; font-size:clamp(18px,4vw,28px); display:flex; align-items:center; gap:.5em}
    .actions{margin-left:auto; display:flex; gap:8px}
    .row{display:flex; align-items:center; gap:10px; justify-content:space-between}
    .hint{color:var(--muted); font-size:clamp(12px,3.5vw,14px); margin:8px 0 2px}
    main{padding:10px 16px 24px}
    .grid{
      display:grid; gap:12px;
      grid-template-columns: repeat(auto-fit, minmax(min(160px, 100%), 1fr));
    }
    .card{
      position:relative; border:1px solid var(--border); background:var(--card);
      border-radius:var(--radius); padding:14px 12px; cursor:pointer; user-select:none;
      transition:transform .06s ease, box-shadow .06s ease, border-color .2s;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
      min-height:104px; display:flex; align-items:center; justify-content:center; text-align:center;
      font-weight:700; letter-spacing:.03em; font-size:clamp(16px,4.8vw,22px);
    }
    .card:active{transform:scale(.98)}
    .badge{
      position:absolute; left:10px; top:8px; font-size:22px; line-height:1;
    }
    .tone-danger{border-color:#ffd6d3; background:#fff5f4}
    .tone-warn{border-color:#ffe4c2; background:#fff8ee}
    .tone-calm{border-color:#cfe3ff; background:#f3f8ff}
    .tone-neutral{border-color:#d9dade; background:#f7f7f8}
    .card .small{position:absolute; right:10px; top:8px; color:var(--muted); font-size:12px}

    .add{
      background:repeating-linear-gradient(45deg,#f9fafb,#f9fafb 10px,#f2f4f7 10px,#f2f4f7 20px);
      border:1px dashed #c6ccd6; color:#334155; font-weight:600;
    }

    /* Placard (overlay) */
    .placard{
      position:fixed; inset:0; display:none; z-index:20;
      background:#000; color:#fff;
    }
    .placard.show{display:block}
    .placard-inner{
      position:relative; width:100%; height:100%;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:6vh 4vw;
    }
    .placard-emoji{font-size:clamp(28px,12vw,120px); line-height:1; margin-bottom:2vh}
    .placard-text{
      width:100%; text-align:center; font-weight:900; letter-spacing:.06em;
      line-height:1.12; word-break:keep-all; text-wrap:balance;
      /* 初期サイズは大きめ、後でJSで微調整 */
      font-size:12vw;
      text-shadow: 0 2px 6px rgba(0,0,0,.28);
    }
    .placard-controls{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      display:flex; gap:8px; flex-wrap:wrap; justify-content:center;
      background:rgba(0,0,0,.25);
      padding:8px 10px; border-radius:999px; backdrop-filter:blur(2px);
    }
    .placard button{font-size:16px}
    .ghost, .danger{
      border:1px solid rgba(255,255,255,.6); background:transparent; color:#fff;
      padding:10px 14px; border-radius:999px; cursor:pointer; font-weight:700;
    }
    .danger{border-color:rgba(255,255,255,.9); background:rgba(255,255,255,.1)}
    .unlock{
      position:fixed; left:10px; top:10px; z-index:22;
      display:none; border:1px solid rgba(255,255,255,.7); color:#fff; background:transparent;
      padding:8px 10px; border-radius:999px; font-weight:700;
    }
    .placard.locked .placard-controls{display:none}
    .placard.locked .unlock{display:inline-block}

    /* Modal */
    .modal{position:fixed; inset:0; display:none; z-index:30; align-items:center; justify-content:center}
    .modal.show{display:flex}
    .scrim{position:absolute; inset:0; background:rgba(0,0,0,.4)}
    .sheet{
      position:relative; z-index:1; width:min(92vw, 720px); max-height:86vh; overflow:auto;
      background:#fff; border-radius:18px; border:1px solid var(--border);
      box-shadow:0 10px 30px rgba(16,24,40,.15);
      padding:16px;
    }
    .sheet h2{margin:0 0 8px}
    .sheet .sub{color:var(--muted); margin:0 0 14px}
    .sheet form{display:grid; gap:10px}
    .field{display:grid; gap:6px}
    label{font-weight:700}
    input[type="text"], input[type="color"], input[type="number"], select{
      font-size:16px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff;
    }
    .btn{
      border:1px solid var(--border); background:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700;
    }
    .btn.primary{background:var(--acc); color:#fff; border-color:#0b6fe0}
    .btn.danger{background:var(--danger); color:#fff; border-color:#e4332a}
    .caps{font-variant-caps: all-small-caps; letter-spacing:.06em}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    /* Tiny helpers */
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}
    .help{font-size:13px; color:var(--muted)}
    footer{padding:20px 0 40px; color:#818899; text-align:center; font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1>🪬 ヘルプ印籠 <span class="caps" style="font-weight:600;color:var(--muted);">— タップで大きく表示</span></h1>
      <div class="actions">
        <button class="btn" id="openHelp" aria-haspopup="dialog">使い方</button>
        <button class="btn" id="openSettings" aria-haspopup="dialog">設定</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <p class="hint">カードをタップ → 画面いっぱいに表示。長押しで読み上げ。</p>
    <div id="grid" class="grid" aria-label="選べる言葉一覧"></div>
  </main>

  <footer class="wrap">© 特別支援教材開発研究所 / だれでも使える支援ツール</footer>

  <!-- Placard (full screen board) -->
  <button id="unlockBtn" class="unlock">🔓 解除</button>
  <div id="placard" class="placard" role="dialog" aria-modal="true" aria-label="言葉の提示">
    <div class="placard-inner" id="placardInner">
      <div class="placard-emoji" id="placardEmoji" aria-hidden="true">🆘</div>
      <div class="placard-text" id="placardText">たすけてください</div>
      <div class="placard-controls" id="placardControls">
        <button class="ghost" id="lockBtn" aria-pressed="false">🔒 ロック</button>
        <button class="ghost" id="speakBtn">🔊 読み上げ</button>
        <button class="ghost" id="fsBtn">⛶ 全画面</button>
        <button class="danger" id="closeBtn" aria-label="閉じる">✖ 閉じる</button>
      </div>
    </div>
  </div>

  <!-- Settings / Help / Add modals (shared shell) -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="scrim" id="closeModal" aria-hidden="true"></div>
    <div class="sheet">
      <h2 id="modalTitle">設定</h2>
      <p class="sub" id="modalDesc">表示や読み上げの好みを保存できます。</p>
      <div id="modalBody"></div>
      <div class="toolbar">
        <button class="btn" id="cancelModal">閉じる</button>
        <button class="btn primary" id="saveModal">保存</button>
      </div>
    </div>
  </div>

  <script>
  ;(()=>{

    /*** 初期カード ***/
    const PRESETS = [
      { text:"たすけてください", color:"#ff3b30", emoji:"🆘", tone:"danger", builtIn:true },
      { text:"こまっています",     color:"#ff9f0a", emoji:"🆘", tone:"warn",   builtIn:true },
      { text:"おしえてください",   color:"#0a84ff", emoji:"🙋", tone:"calm",   builtIn:true },
      { text:"わかりません",       color:"#6c6d70", emoji:"❓", tone:"neutral",builtIn:true },
    ];

    /*** 状態 ***/
    const store = {
      keyItems: "helpPlacard:items",
      keySettings: "helpPlacard:settings",
      items: [],
      settings: { autoSpeak:false, voiceRate:1.0, outline:true },
      current: null,
      longPressTimer: null
    };

    /*** ユーティリティ ***/
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}, children=[])=>{
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==="class") n.className = v;
        else if(k==="dataset") Object.assign(n.dataset, v);
        else if(k.startsWith("on") && typeof v==="function") n.addEventListener(k.slice(2), v);
        else if(v!=null) n.setAttribute(k, v);
      });
      (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>{
        if(typeof c==="string") n.appendChild(document.createTextNode(c)); else n.appendChild(c);
      });
      return n;
    };

    const save = ()=>localStorage.setItem(store.keyItems, JSON.stringify(store.items));
    const saveSettings = ()=>localStorage.setItem(store.keySettings, JSON.stringify(store.settings));
    const load = ()=>{
      try{
        const items = JSON.parse(localStorage.getItem(store.keyItems) || "[]");
        const settings = JSON.parse(localStorage.getItem(store.keySettings) || "{}");
        store.items = [...PRESETS, ...items];
        store.settings = { ...store.settings, ...settings };
      }catch(_){
        store.items = [...PRESETS];
      }
    };

    const getContrast = (hex)=>{
      // hex like #rrggbb
      const c = hex.replace("#",""); const r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16);
      const L = (v)=>{ v/=255; return v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055,2.4) };
      const lum = 0.2126*L(r)+0.7152*L(g)+0.0722*L(b);
      return lum > 0.53 ? "#111" : "#fff";
    };

    /*** カード描画 ***/
    const grid = $("#grid");
    function render(){
      grid.innerHTML = "";
      store.items.forEach((it, idx)=>{
        const card = el("button", { class:`card tone-${it.tone||"neutral"}`, "aria-label":`${it.text} を表示`, type:"button" });
        card.append(
          el("div",{class:"badge", "aria-hidden":"true"}, it.emoji || "🪬"),
          el("div",{}, it.text)
        );
        if(!it.builtIn){
          const del = el("button",{class:"small btn", type:"button", title:"削除"}, "削除");
          del.addEventListener("click",(e)=>{ e.stopPropagation(); store.items.splice(idx,1); save(); render(); });
          card.append(del);
        }
        // 長押しで読み上げ
        card.addEventListener("pointerdown", ()=>{
          store.longPressTimer = setTimeout(()=> speak(it.text), 600);
        });
        ["pointerup","pointerleave","pointercancel","contextmenu"].forEach(ev=>{
          card.addEventListener(ev, ()=>{ clearTimeout(store.longPressTimer); });
        });
        // タップで印籠表示
        card.addEventListener("click", ()=> openPlacard(it) );
        grid.appendChild(card);
      });

      // 追加カード
      const add = el("button",{class:"card add", type:"button", id:"addCard", "aria-label":"カスタム文を追加"}, [
        el("div",{class:"badge","aria-hidden":"true"},"➕"),
        el("div",{},"カスタム文を追加")
      ]);
      add.addEventListener("click", openAddModal);
      grid.appendChild(add);
    }

    /*** 印籠（フル表示） ***/
    const placard = $("#placard");
    const placardText = $("#placardText");
    const placardEmoji = $("#placardEmoji");
    const unlockBtn = $("#unlockBtn");
    const lockBtn = $("#lockBtn");
    const speakBtn = $("#speakBtn");
    const fsBtn = $("#fsBtn");
    const closeBtn = $("#closeBtn");
    const inner = $("#placardInner");

    function openPlacard(item){
      store.current = item;
      const textColor = getContrast(item.color || "#000");
      placard.style.background = item.color || "#000";
      placardText.style.color = textColor;
      placardEmoji.textContent = item.emoji || "🪬";
      placardText.textContent = item.text;
      placard.classList.add("show");
      placard.classList.remove("locked");
      fitTextToBox(placardText, inner, 0.9);
      if(store.settings.outline){
        placardText.style.textShadow = textColor==="#fff" ? "0 2px 6px rgba(0,0,0,.28)" : "0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff";
      }else{
        placardText.style.textShadow = "none";
      }
      if(store.settings.autoSpeak) speak(item.text);
      // フォーカス移動（アクセシビリティ）
      closeBtn.focus({preventScroll:true});
    }
    function closePlacard(){
      placard.classList.remove("show","locked");
      document.exitFullscreen?.();
    }
    function toggleLock(){
      const isLocked = placard.classList.toggle("locked");
      lockBtn.setAttribute("aria-pressed", isLocked ? "true" : "false");
    }
    function fitTextToBox(textEl, boxEl, ratio=0.92){
      // 縦横の両方が収まるまでフォントサイズを微調整
      let max = Math.min(window.innerWidth*0.22, window.innerHeight*0.22); // px
      let min = 16, size = Math.max(min, max);
      textEl.style.fontSize = size + "px";
      for(let i=0;i<40;i++){
        const ok = textEl.scrollWidth <= boxEl.clientWidth*ratio && textEl.scrollHeight <= boxEl.clientHeight*ratio;
        if(ok) break;
        size = Math.max(min, size - Math.ceil(size*0.08));
        textEl.style.fontSize = size + "px";
      }
    }
    function speak(text){
      try{
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "ja-JP";
        u.rate = Number(store.settings.voiceRate || 1.0);
        window.speechSynthesis.speak(u);
      }catch(_){}
    }
    async function toggleFullscreen(){
      const el = document.fullscreenElement;
      if(el) { await document.exitFullscreen(); return; }
      try{ await document.documentElement.requestFullscreen(); }catch(_){}
    }

    // イベント
    lockBtn.addEventListener("click", toggleLock);
    unlockBtn.addEventListener("click", ()=>{ placard.classList.remove("locked"); lockBtn.setAttribute("aria-pressed","false"); });
    speakBtn.addEventListener("click", ()=> store.current && speak(store.current.text));
    fsBtn.addEventListener("click", toggleFullscreen);
    closeBtn.addEventListener("click", closePlacard);
    window.addEventListener("resize", ()=> placard.classList.contains("show") && fitTextToBox(placardText, inner, 0.92));
    document.addEventListener("keydown",(e)=>{
      if(!placard.classList.contains("show")) return;
      if(e.key==="Escape") closePlacard();
      if(e.key.toLowerCase()==="l") toggleLock();
      if(e.key===" "||e.key==="Enter") { e.preventDefault(); speakBtn.click(); }
    });

    /*** モーダル（設定／使い方／追加） ***/
    const modal = $("#modal");
    const modalTitle = $("#modalTitle");
    const modalDesc = $("#modalDesc");
    const modalBody = $("#modalBody");
    $("#openSettings").addEventListener("click", openSettings);
    $("#openHelp").addEventListener("click", openHelp);
    $("#closeModal").addEventListener("click", ()=> modal.classList.remove("show"));
    $("#cancelModal").addEventListener("click", ()=> modal.classList.remove("show"));
    $("#saveModal").addEventListener("click", saveModalContent);

    function openSettings(){
      modalTitle.textContent = "設定";
      modalDesc.textContent = "読み上げや表示の好みを保存できます。";
      modalBody.innerHTML = "";
      const form = el("form",{},[
        fieldToggle("autoSpeak","拡大時に自動で読み上げる", store.settings.autoSpeak),
        fieldRange("voiceRate","読み上げ速度", 0.6, 1.6, 0.05, store.settings.voiceRate),
        fieldToggle("outline","文字を縁取り（視認性アップ）", store.settings.outline),
      ]);
      modalBody.append(form);
      modal.classList.add("show");
    }
    function openHelp(){
      modalTitle.textContent = "使い方";
      modalDesc.textContent = "シンプル操作でサッと伝えられます。";
      modalBody.innerHTML = `
        <ol style="margin:0 0 10px 1.2em">
          <li>言葉のカードを <b>タップ</b> → 画面いっぱいに表示されます。</li>
          <li>（任意）<b>⛶ 全画面</b>でより見やすく。<b>🔒 ロック</b>で誤タップ防止。</li>
          <li>（任意）<b>🔊 読み上げ</b>ボタン、またはカードを<b>長押し</b>で音声。</li>
          <li><b>カスタム文を追加</b>から、よく使う表現を登録できます。</li>
        </ol>
        <p class="help">※設定はブラウザに保存されます。ネット不要で動作します。</p>
      `;
      modal.classList.add("show");
    }

    function fieldToggle(id,label,checked){
      const i = el("input",{type:"checkbox", id, ...(checked?{checked:true}:{})});
      const l = el("label",{for:id}, label);
      const w = el("div",{class:"field"}, [l, i]);
      return w;
    }
    function fieldRange(id,label,min,max,step,value){
      const i = el("input",{type:"number", id:`${id}_num`, value, step, min, max, style:"width:120px"});
      const r = el("input",{type:"range", id, value, step, min, max, style:"width:100%"});
      r.addEventListener("input",()=> i.value = r.value);
      i.addEventListener("input",()=> r.value = i.value);
      const l = el("label",{for:id}, `${label}（${min}〜${max}）`);
      return el("div",{class:"field"},[l, el("div",{class:"row"},[r,i]) ]);
    }
    function saveModalContent(){
      if(modalTitle.textContent==="設定"){
        const autoSpeak = modalBody.querySelector("#autoSpeak")?.checked ?? false;
        const outline = modalBody.querySelector("#outline")?.checked ?? false;
        const voiceRate = Number(modalBody.querySelector("#voiceRate")?.value || 1.0);
        store.settings = { autoSpeak, outline, voiceRate };
        saveSettings();
      }
      if(modalTitle.textContent==="カスタム文を追加"){
        const text = modalBody.querySelector("#text")?.value?.trim();
        const color = modalBody.querySelector("#color")?.value || "#0a84ff";
        const emoji = modalBody.querySelector("#emoji")?.value?.trim() || "🪬";
        if(text){
          store.items.push({ text, color, emoji, tone: pickTone(color), builtIn:false });
          save(); render();
        }
      }
      modal.classList.remove("show");
    }
    function openAddModal(){
      modalTitle.textContent = "カスタム文を追加";
      modalDesc.textContent = "あなたの言葉を登録して、すぐ提示できます。";
      modalBody.innerHTML = "";
      const form = el("form",{},[
        fieldText("text","表示する言葉", "", "例：トイレに行きたいです"),
        fieldText("emoji","絵文字（任意）", "🪬", "例：🙋 / 🆘 / ❓"),
        fieldColor("color","背景色", "#0a84ff"),
        el("p",{class:"help"},"※ 追加したカードは一覧の『削除』から消せます。")
      ]);
      modalBody.append(form);
      modal.classList.add("show");
    }
    function fieldText(id,label,value,placeholder=""){
      const i = el("input",{type:"text", id, value, placeholder});
      const l = el("label",{for:id}, label);
      return el("div",{class:"field"},[l,i]);
    }
    function fieldColor(id,label,value){
      const i = el("input",{type:"color", id, value});
      const l = el("label",{for:id}, label);
      return el("div",{class:"field"},[l,i]);
    }
    function pickTone(hex){
      // おおまかに色味でトーンを決める（UIの見た目用）
      try{
        const h = hex.replace("#",""); const r=parseInt(h.slice(0,2),16), g=parseInt(h.slice(2,4),16), b=parseInt(h.slice(4,6),16);
        if(r>220 && g<130) return "danger";
        if(r>220 && g>150) return "warn";
        if(b>180 && r<80)  return "calm";
        if(r<120 && g<120 && b<120) return "neutral";
      }catch(_){}
      return "calm";
    }

    /*** 起動 ***/
    load(); render();

  })();
  </script>
</body>
</html>
