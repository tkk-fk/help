<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ヘルプ印籠 - 伝えたい言葉を大きく表示</title>
  <meta name="theme-color" content="#ff3b30" />
  <style>
    :root{
      --fg:#111; --bg:#fff; --muted:#666;
      --acc:#0a84ff; --card:#f7f8fa; --border:#e2e6ec;
      --danger:#ff3b30; --warn:#ff9f0a; --calm:#0a84ff; --neutral:#6c6d70;
      --radius:20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg); background:#fff;
      font-family: system-ui,-apple-system,"Segoe UI","Noto Sans JP","Hiragino Sans",Meiryo,sans-serif;
      line-height:1.6;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.9); backdrop-filter:saturate(1.1) blur(6px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:960px; margin:0 auto; padding:calc(12px + env(safe-area-inset-top)) 16px 12px}
    h1{margin:0; font-size:clamp(18px,4vw,28px); display:flex; align-items:center; gap:.5em}
    .row{display:flex; align-items:center; gap:10px; justify-content:space-between}
    .hint{color:var(--muted); font-size:clamp(12px,3.5vw,14px); margin:8px 0 2px}
    main{padding:10px 16px 24px}
    .grid{
      display:grid; gap:12px;
      grid-template-columns: repeat(auto-fit, minmax(min(160px, 100%), 1fr));
    }
    .card{
      position:relative; border:1px solid var(--border); background:var(--card);
      border-radius:var(--radius); padding:14px 12px; cursor:pointer; user-select:none;
      transition:transform .06s ease, box-shadow .06s ease, border-color .2s;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
      min-height:104px; display:flex; align-items:center; justify-content:center; text-align:center;
      font-weight:700; letter-spacing:.03em; font-size:clamp(16px,4.8vw,22px)
    }
    .card:active{transform:scale(.98)}
    .badge{position:absolute; left:10px; top:8px; font-size:22px; line-height:1}
    .tone-danger{border-color:#ffd6d3; background:#fff5f4}
    .tone-warn{border-color:#ffe4c2; background:#fff8ee}
    .tone-calm{border-color:#cfe3ff; background:#f3f8ff}
    .tone-neutral{border-color:#d9dade; background:#f7f7f8}
    .card .small{position:absolute; right:10px; top:8px; color:var(--muted); font-size:12px}

    /* Placard (overlay) */
    .placard{
      position:fixed; inset:0; display:none; z-index:20;
      background:#000; color:#fff;
    }
    .placard.show{display:block}
    .placard-inner{
      position:relative; width:100%; height:100%;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:calc(6vh + env(safe-area-inset-top)) 4vw calc(6vh + env(safe-area-inset-bottom));
    }
    .placard-emoji{font-size:clamp(28px,12vw,120px); line-height:1; margin-bottom:2vh}
    .placard-text{
      width:100%; text-align:center; font-weight:900; letter-spacing:.06em;
      line-height:1.12;
      overflow-wrap:anywhere;
      text-wrap:balance;
      font-size:clamp(28px, 12vw, 120px);
      text-shadow: 0 2px 6px rgba(0,0,0,.28);
    }
    .placard-controls{
      position:fixed; left:50%; bottom:calc(14px + env(safe-area-inset-bottom)); transform:translateX(-50%);
      display:flex; gap:8px; flex-wrap:wrap; justify-content:center;
      background:rgba(0,0,0,.25);
      padding:8px 10px; border-radius:999px; backdrop-filter:blur(2px);
    }
    .placard button{font-size:16px}
    .ghost, .danger, .btn, .card { touch-action: manipulation; }
    .ghost, .danger{
      border:1px solid rgba(255,255,255,.6); background:transparent; color:#fff;
      padding:10px 14px; border-radius:999px; cursor:pointer; font-weight:700;
    }
    .danger{border-color:rgba(255,255,255,.9); background:rgba(255,255,255,.1)}
    .unlock{
      position:absolute; left:10px; top:10px; z-index:22;
      display:none; border:2px solid rgba(255,255,255,.9); color:#fff; background:rgba(0,0,0,.25);
      padding:10px 12px; border-radius:999px; font-weight:800; backdrop-filter: blur(2px);
    }
    .placard.locked .placard-controls{display:none}
    .placard.locked .unlock{display:inline-block}

    /* 擬似フルスクリーン（iOSフォールバック） */
    .placard.pseudo-fs { position:fixed; inset:0; width:100vw; height:100vh; }

    /* モーダル（カード追加用） */
    .modal{position:fixed; inset:0; display:none; z-index:30; align-items:center; justify-content:center}
    .modal.show{display:flex}
    .scrim{position:absolute; inset:0; background:rgba(0,0,0,.4)}
    .sheet{
      position:relative; z-index:1; width:min(92vw, 560px); max-height:86vh; overflow:auto;
      background:#fff; border-radius:18px; border:1px solid var(--border);
      box-shadow:0 10px 30px rgba(16,24,40,.15);
      padding:16px;
    }
    .sheet h2{margin:0 0 8px}
    .sheet form{display:grid; gap:10px}
    .field{display:grid; gap:6px}
    label{font-weight:700}
    input[type="text"], input[type="color"], select{
      font-size:16px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff;
    }
    .btn{
      border:1px solid var(--border); background:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700;
    }
    .btn.primary{background:var(--acc); color:#fff; border-color:#0b6fe0}
    .btn.danger{background:var(--danger); color:#fff; border-color:#e4332a}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    footer{padding:20px 0 40px; color:#818899; text-align:center; font-size:12px}

    /* フォーカス可視化 */
    .btn:focus-visible, .card:focus-visible, .ghost:focus-visible, .danger:focus-visible{
      outline: 3px solid rgba(10,132,255,.6);
      outline-offset: 2px;
    }

    /* 右下FAB */
    .fab{
      position:fixed; right:16px; bottom:calc(16px + env(safe-area-inset-bottom));
      z-index:25; padding:14px 16px; border-radius:999px; font-weight:800;
      background:#0a84ff; color:#fff; border:none; box-shadow:0 6px 18px rgba(0,0,0,.2);
      cursor:pointer;
    }
  </style>
</head>
<body>
  <header id="hdr">
    <div class="wrap row">
      <h1>🪬 ヘルプ印籠 <span class="caps" style="font-weight:600;color:var(--muted);">— タップで大きく表示</span></h1>
    </div>
  </header>

  <main id="main" class="wrap">
    <p class="hint">カードをタップ → 画面いっぱいに表示。</p>
    <div id="grid" class="grid" aria-label="選べる言葉一覧"></div>
  </main>

  <footer id="ftr" class="wrap">© 特別支援教材開発研究所 / だれでも使える支援ツール</footer>

  <!-- Placard -->
  <div id="placard" class="placard" role="dialog" aria-modal="true" aria-label="言葉の提示" aria-labelledby="placardText">
    <button id="unlockBtn" class="unlock">🔓 解除</button>
    <div class="placard-inner" id="placardInner">
      <div class="placard-emoji" id="placardEmoji" aria-hidden="true">🆘</div>
      <div class="placard-text" id="placardText">たすけてください</div>
      <div class="placard-controls" id="placardControls">
        <button class="ghost" id="lockBtn" aria-pressed="false">🔒 ロック</button>
        <button class="ghost" id="speakBtn">🔊 読み上げ</button>
        <button class="ghost" id="fsBtn">⛶ 全画面</button>
        <button class="danger" id="closeBtn" aria-label="閉じる">✖ 閉じる</button>
      </div>
    </div>
  </div>

  <!-- Add Card Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="scrim" id="closeModal" aria-hidden="true"></div>
    <div class="sheet">
      <h2 id="modalTitle">カードを追加</h2>
      <form id="addForm">
        <div class="field">
          <label for="fText">表示する言葉</label>
          <input id="fText" type="text" placeholder="例：トイレに行きたいです" required />
        </div>
        <div class="field">
          <label for="fEmoji">アイコン（絵文字）</label>
          <input id="fEmoji" type="text" placeholder="例：🚻 / 🙋 / 🆘 など" maxlength="4" />
        </div>
        <div class="field">
          <label for="fColor">背景色（印籠色）</label>
          <input id="fColor" type="color" value="#0a84ff" />
        </div>
        <div class="field">
          <label for="fTone">トーン</label>
          <select id="fTone">
            <option value="calm">穏やか（青）</option>
            <option value="warn">注意（橙）</option>
            <option value="danger">緊急（赤）</option>
            <option value="neutral">中立（灰）</option>
          </select>
        </div>
      </form>
      <div class="toolbar">
        <button class="btn" id="cancelModal" type="button">閉じる</button>
        <button class="btn primary" id="saveModal" type="button">保存</button>
      </div>
    </div>
  </div>

  <!-- FAB -->
  <button id="addBtn" class="fab" aria-haspopup="dialog">＋ カード追加</button>

  <script>
  ;(()=>{
    // --- 初期プリセット（ストレージには保存しない） ---
    const PRESETS = [
      { text:"たすけてください", color:"#ff3b30", emoji:"🆘", tone:"danger", builtIn:true },
      { text:"こまっています",     color:"#ff9f0a", emoji:"🆘", tone:"warn",   builtIn:true },
      { text:"おしえてください",   color:"#0a84ff", emoji:"🙋", tone:"calm",   builtIn:true },
      { text:"わかりません",       color:"#6c6d70", emoji:"❓", tone:"neutral",builtIn:true },
    ];
    const presetKeySet = new Set(PRESETS.map(k=>`${k.text}|${k.emoji||""}|${k.color||""}`));

    // --- ストア（ユーザー作成カードのみ保存） ---
    const store = {
      keyItems: "helpPlacard:items",
      keySettings: "helpPlacard:settings",
      items: [], // ユーザー作成カードのみ
      settings: { autoSpeak:false, voiceRate:1.0 },
      current: null
    };

    // --- ユーティリティ ---
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}, children=[])=>{
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==="class") n.className = v;
        else if(k==="dataset") Object.assign(n.dataset, v);
        else if(k.startsWith("on") && typeof v==="function") n.addEventListener(k.slice(2), v);
        else if(v!=null) n.setAttribute(k, v);
      });
      (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>{
        if(typeof c==="string") n.appendChild(document.createTextNode(c)); else n.appendChild(c);
      });
      return n;
    };
    const keyOf = (x)=>`${x.text}|${x.emoji||""}|${x.color||""}`;

    function dedupe(list){
      const seen = new Set();
      return list.filter(it=>{ const k=keyOf(it); if(seen.has(k)) return false; seen.add(k); return true; });
    }

    // --- localStorage 安全保存 ---
    function safeSet(key, val){ try{ localStorage.setItem(key, val); }catch(e){} }
    const save = ()=> safeSet(store.keyItems, JSON.stringify(store.items));
    const saveSettings = ()=> safeSet(store.keySettings, JSON.stringify(store.settings));
    const load = ()=>{
      try{
        const raw = JSON.parse(localStorage.getItem(store.keyItems) || "[]");
        // builtIn除外＋プリセットと同一キーのユーザー項目も削除（表示だけでなく保存もクリーン化）
        const filtered = Array.isArray(raw) ? raw.filter(x=> !x.builtIn && !presetKeySet.has(keyOf(x))) : [];
        store.items = dedupe(filtered);
        const settings = JSON.parse(localStorage.getItem(store.keySettings) || "{}");
        store.settings = { ...store.settings, ...settings };
      }catch(_){
        store.items = [];
      }
    };

    // --- フィードバック音/触覚 ---
    let audioCtx = null;
    function beep(duration=80, freq=880){
      try{
        audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value = freq; o.type = "sine";
        g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration/1000);
        o.stop(audioCtx.currentTime + duration/1000 + 0.005);
      }catch(_){}
    }
    function haptic(ms=10){ try{ navigator.vibrate?.(ms); }catch(_){ } }

    // --- UI描画 ---
    const grid = $("#grid");
    function render(){
      grid.innerHTML = "";
      const all = [...PRESETS, ...store.items];
      const list = dedupe(all); // 念のため再度デデュープ
      list.forEach((it)=>{
        const card = el("button", { class:`card tone-${it.tone||"neutral"}`, type:"button" });
        card.append(
          el("div",{class:"badge"}, it.emoji || "🪬"),
          el("div",{}, it.text)
        );
        if(!it.builtIn){
          const del = el("button",{class:"small btn", type:"button"}, "削除");
          del.setAttribute("aria-label", `${it.text} を削除`);
          del.addEventListener("click",(e)=>{ e.stopPropagation(); removeUserCard(it); });
          del.addEventListener("keydown",(e)=>{ if(e.key===" "||e.key==="Enter"){ e.stopPropagation(); }});
          card.append(del);
        }
        card.addEventListener("click", ()=> openPlacard(it));
        grid.appendChild(card);
      });
    }

    function removeUserCard(target){
      store.items = store.items.filter(x=> keyOf(x)!==keyOf(target));
      save(); render();
    }

    // --- Placard ---
    const placard = $("#placard"), placardText=$("#placardText"),
          placardEmoji=$("#placardEmoji"), unlockBtn=$("#unlockBtn"),
          lockBtn=$("#lockBtn"), speakBtn=$("#speakBtn"),
          fsBtn=$("#fsBtn"), closeBtn=$("#closeBtn");

    let lastFocus = null;

    function speak(text){
      if(!("speechSynthesis" in window)) return;
      try{
        const synth = window.speechSynthesis;
        synth.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang="ja-JP"; u.rate=Number(store.settings.voiceRate||1.0);
        const t = setInterval(()=>{ if(!synth.speaking) synth.resume(); else clearInterval(t); }, 200);
        synth.speak(u);
      }catch(_){}
    }

    async function goFullscreen(el){
      try{
        if(document.fullscreenElement) return;
        if(el.requestFullscreen){
          await el.requestFullscreen({navigationUI:"hide"});
        }else{
          throw new Error("no fullscreen");
        }
      }catch{
        placard.classList.add("pseudo-fs");
      }
    }
    function exitFullscreen(){
      placard.classList.remove("pseudo-fs");
      try{ document.exitFullscreen?.(); }catch(_){}
    }

    function setBackgroundAriaHidden(flag){
      ["hdr","main","ftr"].forEach(id=>{
        const n = document.getElementById(id);
        if(!n) return;
        if(flag) n.setAttribute("aria-hidden","true"); else n.removeAttribute("aria-hidden");
      });
    }

    function openPlacard(item){
      store.current = item;
      document.documentElement.style.overflow="hidden";
      setBackgroundAriaHidden(true);

      placard.style.background = item.color || "#000";
      placardText.textContent = item.text;
      placardEmoji.textContent = item.emoji || "🪬";
      placard.classList.add("show"); placard.classList.remove("locked");

      haptic(12); beep(70, 1000);

      lastFocus = document.activeElement;
      closeBtn.focus();

      if(store.settings.autoSpeak) speak(item.text);
    }
    function closePlacard(){
      placard.classList.remove("show","locked");
      exitFullscreen();
      document.documentElement.style.overflow="";
      setBackgroundAriaHidden(false);
      lastFocus?.focus();
    }
    function toggleLock(){ placard.classList.toggle("locked"); }

    fsBtn.addEventListener("pointerup", e=>{
      e.preventDefault(); e.stopPropagation();
      if(!document.fullscreenElement && !placard.classList.contains("pseudo-fs")) goFullscreen(placard);
      else exitFullscreen();
    });
    lockBtn.addEventListener("click", toggleLock);
    unlockBtn.addEventListener("click", ()=> placard.classList.remove("locked"));
    speakBtn.addEventListener("click", ()=> store.current && speak(store.current.text));
    closeBtn.addEventListener("click", closePlacard);

    document.addEventListener("keydown", (e)=>{
      if(!placard.classList.contains("show")) return;
      if(e.key==="Escape") closePlacard();
      if(e.key==="Tab"){
        const focusables = placard.querySelectorAll("button,[href],[tabindex]:not([tabindex='-1'])");
        if(!focusables.length) return;
        const first=focusables[0], last=focusables[focusables.length-1];
        if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
      }
    });
    window.addEventListener("orientationchange", ()=>{ exitFullscreen(); });

    // --- カード追加モーダル ---
    const modal = $("#modal"), addBtn=$("#addBtn");
    const addForm = $("#addForm");
    const fText=$("#fText"), fEmoji=$("#fEmoji"), fColor=$("#fColor"), fTone=$("#fTone");

    function openModal(){
      addForm.reset();
      fColor.value = "#0a84ff";
      fTone.value = "calm";
      modal.classList.add("show");
      setTimeout(()=> fText.focus(), 0);
    }
    function closeModal(){ modal.classList.remove("show"); }

    $("#closeModal").addEventListener("click", closeModal);
    $("#cancelModal").addEventListener("click", closeModal);
    addBtn.addEventListener("click", openModal);

    function saveNewCard(){
      const text = (fText.value||"").trim();
      if(!text){ fText.focus(); return; }
      const emoji = (fEmoji.value||"").trim() || "🪬";
      const color = fColor.value || "#0a84ff";
      const tone  = fTone.value || "neutral";
      const newItem = { text, emoji, color, tone, builtIn:false };

      // プリセットと重複するカードは保存しない（表示はプリセットを使う）
      if(presetKeySet.has(keyOf(newItem))) { closeModal(); return; }

      // 既存ユーザーカードと重複していればスキップ
      if(store.items.some(x=> keyOf(x)===keyOf(newItem))) { closeModal(); return; }

      store.items.push(newItem);
      store.items = dedupe(store.items);
      save();
      render();
      closeModal();
    }
    $("#saveModal").addEventListener("click", saveNewCard);
    addForm.addEventListener("submit", (e)=>{ e.preventDefault(); saveNewCard(); });

    // --- 初期化 ---
    load();
    render();
  })();
  </script>
</body>
</html>
